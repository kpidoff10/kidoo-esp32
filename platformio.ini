; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html
;
; ============================================
; Architecture multi-plateforme ESP32
; ============================================
; Ce projet supporte plusieurs plateformes ESP32 avec un seul code source :
; - ESP32-S3 (Basic) : Dual-core + PSRAM
; - ESP32-C3 (Mini)  : Single-core RISC-V
;
; La détection du chip est automatique via core_config.h
; Les pins GPIO sont définis dans models/{basic|mini}/config/config.h

[platformio]
default_envs = basic

; ============================================
; Configuration commune (valeurs par défaut)
; ============================================
; Fichiers sources communs à tous les modèles :
; - main.cpp
; - models/common/** (tous les managers communs)
; - models/model_config.h
; - models/model_init.h
; - models/model_pubnub_routes.h
; - models/model_serial_commands.h

[env]
platform = espressif32
framework = arduino
; Évite ModuleNotFoundError: No module named 'intelhex' (esptool >= 1.40501 requiert intelhex)
platform_packages = tool-esptoolpy@~1.40501.0

; esptoolpy est inclus automatiquement dans la plateforme espressif32
; Plus besoin de spécifier une version explicite (causait des erreurs sur Windows)

; Note: build_src_filter est défini dans chaque environnement spécifique
; car PlatformIO ne fusionne pas les listes lors de l'héritage

; Flags de compilation communs
build_flags = 
	-DARDUINO_USB_MODE=1
	-DARDUINO_USB_CDC_ON_BOOT=1
	-DCORE_DEBUG_LEVEL=0
	-Os
	-ffunction-sections
	-fdata-sections
	-Wl,--gc-sections
	; FastLED RMT driver natif ESP32
	-DFASTLED_ESP32_FLASH_LOCK=1

; Dépendances communes
lib_deps = 
	adafruit/Adafruit NeoPixel@^1.12.4
	bblanchon/ArduinoJson@^7.0.0

; Configuration Serial Monitor commune
monitor_speed = 115200
monitor_dtr = 0
monitor_rts = 0
upload_speed = 921600

; ============================================
; Environnement Basic - ESP32-S3
; ============================================
; Board: ESP32-S3-DevKitC-1 (AYWHP / ESP-1-N16R8)
;   - 16MB Flash QD / 8MB PSRAM OPI
;   - 2x USB-C: USB-OTG (UART) + USB-JTAG (debug)
;   - LED RGB intégrée sur GPIO 48

[env:basic]
; Hérite de [env] et surcharge les valeurs spécifiques
board = esp32-s3-devkitc-1
board_build.partitions = default_16MB.csv
board_build.flash_mode = qio
board_upload.flash_size = 16MB
; PSRAM OPI 8MB - Configuration mémoire pour N16R8
board_build.arduino.memory_type = qio_opi

; Filtrage des sources : fichiers communs (hérités) + répertoire basic
; Les fichiers communs sont définis ici car PlatformIO ne fusionne pas build_src_filter
build_src_filter = 
	+<main.cpp>
	+<models/common/**>
	+<models/model_config.h>
	+<models/model_init.h>
	+<models/model_pubnub_routes.h>
	+<models/model_serial_commands.h>
	+<models/basic/**>

build_flags = 
	${env.build_flags}
	-DKIDOO_MODEL_BASIC
	; LED RGB intégrée DevKitC-1
	-DBUILTIN_RGB_LED_PIN=48
	; PSRAM 8MB OPI
	-DBOARD_HAS_PSRAM

; Dépendances supplémentaires pour Basic (NFC, Audio)
lib_deps = 
	${env.lib_deps}
	adafruit/Adafruit PN532@^1.3.4
	https://github.com/schreibfaul1/ESP32-audioI2S.git

; ============================================
; Environnement Mini - ESP32-C3
; ============================================
; Board: ESP32-C3-DevKitM-1 ou équivalent
;   - 4MB Flash
;   - Pas de PSRAM
;   - Single-core RISC-V 160MHz
;   - WiFi + BLE 5.0
;   - USB natif (pas besoin de convertisseur USB-Serial)

[env:mini]
platform = espressif32
; Hérite de [env] et surcharge les valeurs spécifiques
board = esp32-c3-devkitm-1
; Utiliser huge_app.csv pour avoir 3MB pour l'app (au lieu de 1.25MB par défaut)
board_build.partitions = huge_app.csv
board_build.flash_mode = dio

; Filtrage des sources : fichiers communs (hérités) + répertoire mini
; Les fichiers communs sont définis ici car PlatformIO ne fusionne pas build_src_filter
; Le code audio est automatiquement exclu via #ifdef HAS_AUDIO (non défini dans mini/config/config.h)
build_src_filter = 
	+<main.cpp>
	+<models/common/**>
	+<models/model_config.h>
	+<models/model_init.h>
	+<models/model_pubnub_routes.h>
	+<models/model_serial_commands.h>
	+<models/mini/**>

build_flags = 
	${env.build_flags}
	-DKIDOO_MODEL_MINI
	-DESP32C3
	; FastLED RMT driver - 2 canaux pour C3
	-DFASTLED_RMT_MAX_CHANNELS=2
	; Optimisations supplémentaires pour réduire la taille du firmware
	-ffast-math

; Dépendances communes uniquement (pas de NFC/Audio sur Mini)
lib_deps = 
	${env.lib_deps}

; Ignorer explicitement les bibliothèques non compatibles avec ESP32-C3
lib_ignore = 
	ESP32-audioI2S
	Adafruit PN532

; ============================================
; Environnement Dream - ESP32-S3
; ============================================
; Board: ESP32-S3-DevKitC-1 (AYWHP / ESP-1-N16R8)
;   - 16MB Flash QD / 8MB PSRAM OPI
;   - 2x USB-C: USB-OTG (UART) + USB-JTAG (debug)
;   - LED RGB intégrée sur GPIO 48

[env:dream]
platform = espressif32
; Hérite de [env] et surcharge les valeurs spécifiques
board = esp32-c3-devkitm-1
; Utiliser huge_app.csv pour avoir 3MB pour l'app (au lieu de 1.25MB par défaut)
board_build.partitions = huge_app.csv
board_build.flash_mode = dio

; Filtrage des sources : fichiers communs (hérités) + répertoire mini
; Les fichiers communs sont définis ici car PlatformIO ne fusionne pas build_src_filter
; Le code audio est automatiquement exclu via #ifdef HAS_AUDIO (non défini dans mini/config/config.h)
build_src_filter = 
	+<main.cpp>
	+<models/common/**>
	+<models/model_config.h>
	+<models/model_init.h>
	+<models/model_pubnub_routes.h>
	+<models/model_serial_commands.h>
	+<models/dream/**>

build_flags = 
	${env.build_flags}
	-DKIDOO_MODEL_DREAM
	-DHAS_WIFI
	-DESP32C3
	; Optimisations supplémentaires pour réduire la taille du firmware
	-ffast-math

; Dépendances communes uniquement (pas de NFC/Audio sur Mini)
lib_deps = 
	${env.lib_deps}

; Ignorer explicitement les bibliothèques non compatibles avec ESP32-C3
lib_ignore = 
	ESP32-audioI2S
	Adafruit PN532